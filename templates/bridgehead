#!/usr/bin/env bash
set -e
set -o pipefail

{%- let config_dir = filters::path(conf.path)? %}
{%- let pwd = filters::path(conf.srv_dir)? %}
cd {{ pwd }}

COMPOSE_FILES="$(ls services | awk '{print " -f services/" $0}')"
[ -e ./docker-compose.override.yml ] && COMPOSE_FILES+=" -f docker-compose.override.yml"

case "$1" in
	logs)
		shift 2
		exec journalctl -u bridgehead@$PROJECT -u bridgehead-update@$PROJECT -a $@
		;;
	compose)
		shift
		exec docker compose -p bridgehead $COMPOSE_FILES $@
		;;
	update)
		docker pull samply/rusthead:latest
		exec docker run -v {{ config_dir }}:{{ config_dir }} -v {{ pwd }}:{{ pwd }} samply/rusthead:latest update
		;;
	enroll)
        do_enroll() {
            {%- let priv_key_file = conf.path.join(format!("pki/{}.priv.pem", self.conf.site_id)) %}
            docker run --rm -v {{ config_dir }}/pki:{{ config_dir }}/pki docker.verbis.dkfz.de/cache/samply/beam-enroll:latest --output-file {{ priv_key_file|path }} --proxy-id {{ conf.site_id }}.$1
            chmod 600 {{ priv_key_file|path }}
        }
        {% for broker in beam_networks -%}
		    do_enroll {{ broker }}
        {%- endfor %}
		;;
	*)
		exit 1
		;;
esac
