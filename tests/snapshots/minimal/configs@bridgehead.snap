---
source: src/config.rs
expression: file
info: bridgehead
input_file: tests/configs/minimal.toml
---
#!/usr/bin/env bash
set -e
set -o pipefail

# Ensure the script is running in memory to avoid issues with self modification on update
[ "$LOADED" = 1 ] || LOADED=1 exec bash <(cat "$0") "$@"
cd [TMP_DIR]


main() {
    case "$1" in
        install)
            [ "$(id -u)" -ne 0 ] && echo "Install command must be run as root." && exit 1
            useradd -M -g docker -N bridgehead &>/dev/null || echo "Using existing user bridgehead."
            chown -R bridgehead:docker .
            chmod -R g+sw .
            sudo -u bridgehead git init -b main --shared=group
            git config --global --add safe.directory [TMP_DIR]
            git config --local user.email "bridgehead@samply.de"
            git config --local user.name "Bridgehead"
            if ! systemctl status docker &> /dev/null; then
                echo "Systemd is not active or docker is not running via systemd. Skipping systemd setup."
                set +e
                sudo -u bridgehead ./bridgehead update
                exit_code=$?
                set -e
                if [ "$exit_code" != "0" ] && [ "$exit_code" != "3" ]; then
                    echo "Failed to update bridgehead"
                    exit $exit_code
                fi
            else
                install_systemd
            fi
            echo "Installation complete."
            echo "You may start the bridgehead service with 'systemctl start bridgehead' or '[TMP_DIR]/bridgehead compose up' now."
            ;;
        logs)
            shift
            exec journalctl -u bridgehead -u bridgehead-update -a $@
            ;;
        compose)
            compose_files="$(ls services | awk '{print " -f services/" $0}')"
            [ -e ./docker-compose.override.yml ] && compose_files+=" -f docker-compose.override.yml"
            shift
            exec docker compose -p bridgehead --env-file .env $compose_files -f docker-image.lock.yml $@
            ;;
        update)
            docker image prune -f
            docker pull samply/rusthead:latest &>/dev/null || echo "Failed to pull latest rusthead image. Using latest local image."
            docker_config=~/.docker/config.json
            docker_config_mount=""
            [ -f "$docker_config" ] && docker_config_mount="-v $docker_config:/root/.docker/config.json:ro"
            docker run --rm \
                -v [TMP_DIR]:[TMP_DIR] \
                -v /var/run/docker.sock:/var/run/docker.sock \
                $docker_config_mount \
                -e BRIDGEHEAD_CONFIG_PATH=[TMP_DIR] \
                -u "$(id -u bridgehead):$(id -g bridgehead)" \
                samply/rusthead:latest update
            ;;
        *)
            echo "Unknown bridgehead command '$@'"
            exit 1
            ;;
    esac
}

install_systemd() {
    cat <<EOF > /etc/systemd/system/bridgehead.service
[Unit]
Description=Bridgehead Service
Requires=docker.service

[Service]
ExecStart=[TMP_DIR]/bridgehead compose up
Restart=always
User=bridgehead
Group=docker

[Install]
WantedBy=multi-user.target
EOF
    cat <<EOF > /etc/systemd/system/bridgehead-update.service
[Unit]
Description=Bridgehead Update Service
Requires=docker.service

[Service]
ExecStart=[TMP_DIR]/bridgehead update
User=bridgehead
Group=docker
ExecStopPost=+/bin/bash -c 'if [ "\$EXIT_STATUS" = "3" ]; then systemctl restart bridgehead.service; fi'
EOF
    cat <<EOF > /etc/systemd/system/bridgehead-update.timer
[Unit]
Description=Daily Updates at 6am of Bridgehead

[Timer]
OnCalendar=*-*-* 06:00:00
Persistent=true

[Install]
WantedBy=basic.target
EOF
    systemctl daemon-reload
    systemctl start bridgehead-update.service
    echo "Enabling autostart of bridgehead.service"
    systemctl enable bridgehead.service
    echo "Enabling auto-updates for bridgehead.service ..."
    systemctl enable --now bridgehead-update.timer
}

main "$@"
