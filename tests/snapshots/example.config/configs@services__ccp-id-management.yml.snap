---
source: src/config.rs
expression: file
info: services/ccp-id-management.yml
input_file: tests/configs/example.config.toml
---

services:
  id-manager:
    image: docker.verbis.dkfz.de/bridgehead/magicpl
    environment:
      TOMCAT_REVERSEPROXY_FQDN: dummy.local
      TOMCAT_REVERSEPROXY_SSL: "true"
      MAGICPL_SITE: Dummy
      MAGICPL_ALLOWED_ORIGINS: https://dummy.local
      MAGICPL_LOCAL_PATIENTLIST_APIKEY: ${CCP_ID_MANAGEMENT_APIKEY}
      MAGICPL_CENTRAXX_APIKEY: test_upload_apikey
      MAGICPL_CONNECTOR_APIKEY: test_read_apikey
      MAGICPL_CENTRAL_PATIENTLIST_APIKEY: test_central_patientlist_apikey
      MAGICPL_CONTROLNUMBERGENERATOR_APIKEY: test_controlnumbergenerator_apikey
    depends_on:
      - patientlist
      - idm-traefik-forward-auth
    labels:
      - "traefik.enable=true"
      # Router with Authentication
      - "traefik.http.routers.id-manager.rule=PathPrefix(`/id-manager`)"
      - "traefik.http.routers.id-manager.tls=true"
      - "traefik.http.routers.id-manager.middlewares=traefik-forward-auth-idm"
      - "traefik.http.routers.id-manager.service=id-manager-service"
      # Router without Authentication
      - "traefik.http.routers.id-manager-compatibility.rule=PathPrefix(`/id-manager/paths/translator/getIds`)"
      - "traefik.http.routers.id-manager-compatibility.tls=true"
      - "traefik.http.routers.id-manager-compatibility.service=id-manager-service"
      # Definition of Service
      - "traefik.http.services.id-manager-service.loadbalancer.server.port=8080"
      - "traefik.http.services.id-manager-service.loadbalancer.server.scheme=http"

  patientlist:
    image: docker.verbis.dkfz.de/bridgehead/mainzelliste
    environment:
      - TOMCAT_REVERSEPROXY_FQDN=dummy.local
      - TOMCAT_REVERSEPROXY_SSL=true
      - ML_SITE=Dummy
      - ML_DB_HOST=ccp-id-management-db
      - ML_DB_NAME=ccp-id-management
      - ML_DB_USER=ccp-id-management
      - ML_DB_PASS=${CCP_ID_MANAGEMENT_DB_PASSWORD}
      - ML_API_KEY=${CCP_ID_MANAGEMENT_APIKEY}
      - ML_UPLOAD_API_KEY=test_upload_apikey
      # Add Variables from /etc/patientlist-id-generators.env
      - ML_BK_IDGENERATOR_RANDOM_1=1
      - ML_BK_IDGENERATOR_RANDOM_2=2
      - ML_BK_IDGENERATOR_RANDOM_3=3
      - ML_MDS_IDGENERATOR_RANDOM_1=1
      - ML_MDS_IDGENERATOR_RANDOM_2=2
      - ML_MDS_IDGENERATOR_RANDOM_3=3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.patientlist.rule=PathPrefix(`/patientlist`)"
      - "traefik.http.services.patientlist.loadbalancer.server.port=8080"
      - "traefik.http.routers.patientlist.tls=true"
    depends_on:
      - ccp-id-management-db

  idm-traefik-forward-auth:
    image: docker.verbis.dkfz.de/cache/oauth2-proxy/oauth2-proxy:latest
    environment:
      - http_proxy=http://forward-proxy:3128/
      - https_proxy=http://forward-proxy:3128/
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_SKIP_PROVIDER_BUTTON=true
      - OAUTH2_PROXY_OIDC_ISSUER_URL=https://sso.verbis.dkfz.de/application/o/dummy-private/
      - OAUTH2_PROXY_CLIENT_ID=dummy-private
      - OAUTH2_PROXY_CLIENT_SECRET=${OIDC_CCP_CLIENT_SECRET}
      - OAUTH2_PROXY_COOKIE_SECRET=test_auth_cookie_secret
      - OAUTH2_PROXY_COOKIE_NAME=_BRIDGEHEAD_oauth2_idm
      - OAUTH2_PROXY_COOKIE_DOMAINS=.dummy.local
      - OAUTH2_PROXY_HTTP_ADDRESS=:4180
      - OAUTH2_PROXY_REVERSE_PROXY=true
      - OAUTH2_PROXY_WHITELIST_DOMAINS=.dummy.local
      - OAUTH2_PROXY_UPSTREAMS=static://202
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_SCOPE=openid profile email
      # Pass Authorization Header and some user information to backend services
      - OAUTH2_PROXY_SET_AUTHORIZATION_HEADER=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_ALLOWED_GROUPS=DKTK_CCP_Dummy_Verwalter
      - OAUTH2_PROXY_OIDC_GROUPS_CLAIM=groups
      - OAUTH2_PROXY_PROXY_PREFIX=/oauth2-idm
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.idm-traefik-forward-auth.loadbalancer.server.port=4180"
      - "traefik.http.routers.traefik-forward-auth.rule=Host(`dummy.local`) && PathPrefix(`/oauth2-idm`)"
      - "traefik.http.routers.traefik-forward-auth.tls=true"
      - "traefik.http.middlewares.traefik-forward-auth-idm.forwardauth.address=http://idm-traefik-forward-auth:4180"
      - "traefik.http.middlewares.traefik-forward-auth-idm.forwardauth.authResponseHeaders=Authorization"
    depends_on:
      forward-proxy:
        condition: service_healthy

volumes:
  patientlist-db-data:
