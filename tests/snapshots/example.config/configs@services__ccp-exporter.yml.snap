---
source: src/config.rs
expression: file
info: services/ccp-exporter.yml
input_file: tests/configs/example.config.toml
---
services:
  ccp-exporter:
    image: docker.verbis.dkfz.de/ccp/dktk-exporter:latest
    environment:
      JAVA_OPTS: "-Xms1G -Xmx8G -XX:+UseG1GC"
      LOG_LEVEL: "INFO"
      EXPORTER_API_KEY: "${CCP_EXPORTER_API_KEY}"
      CROSS_ORIGINS: "https://dummy.local"
      EXPORTER_DB_USER: "ccp-exporter"
      EXPORTER_DB_PASSWORD: "${CCP_EXPORTER_DB_PASSWORD}"
      EXPORTER_DB_URL: "jdbc:postgresql://ccp-exporter-db:5432/ccp-exporter"
      HTTP_RELATIVE_PATH: "/ccp-exporter"
      BLAZE_URL: "http://ccp-blaze:8080/fhir"
      HTTP_SERVLET_REQUEST_SCHEME: "https"
      OPAL_PASSWORD: "${CCP_EXPORTER_OPAL_PW}"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.exporter_ccp.rule=PathPrefix(`/ccp-exporter`)"
      - "traefik.http.services.exporter_ccp.loadbalancer.server.port=8092"
      - "traefik.http.routers.exporter_ccp.tls=true"
      - "traefik.http.middlewares.exporter_ccp_strip.stripprefix.prefixes=/ccp-exporter"
      - "traefik.http.routers.exporter_ccp.middlewares=exporter_ccp_strip"
    volumes:
      - "ccp-exporter-files:/app/exporter-files/output"
    depends_on:
      - ccp-exporter-db

  ccp-reporter:
    image: docker.verbis.dkfz.de/ccp/dktk-reporter:latest
    environment:
      JAVA_OPTS: "-Xms1G -Xmx8G -XX:+UseG1GC"
      LOG_LEVEL: "INFO"
      CROSS_ORIGINS: "https://dummy.local"
      HTTP_RELATIVE_PATH: "/ccp-reporter"
      EXPORTER_API_KEY: "${CCP_EXPORTER_API_KEY}"
      EXPORTER_URL: "http://ccp-exporter:8092"
      LOG_FHIR_VALIDATION: "false"
      HTTP_SERVLET_REQUEST_SCHEME: "https"
    volumes:
      - "ccp-reporter-files:/app/reports"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.reporter_ccp.rule=PathPrefix(`/ccp-reporter`)"
      - "traefik.http.services.reporter_ccp.loadbalancer.server.port=8095"
      - "traefik.http.routers.reporter_ccp.tls=true"
      - "traefik.http.middlewares.reporter_ccp_strip.stripprefix.prefixes=/ccp-reporter"
      - "traefik.http.routers.reporter_ccp.middlewares=reporter_ccp_strip"


volumes:
  ccp-exporter-files:
  ccp-reporter-files:
